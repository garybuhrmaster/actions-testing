---
name: build

on:
  push:
    branches: [ main ]

  pull_request:
    branches: [ main ]

jobs:

  clang-tidy:
    name: Clang-tidy

    runs-on: ubuntu-latest

    container:
      image: fedora:rawhide

    steps:

      - name: Fedora OS update
        run: dnf upgrade -y

      - name: Fedora OS install ansible
        run: dnf install ansible -y

      - name: Checkout MythTV/ansible repo
        uses: actions/checkout@v3
        with:
          repository: MythTV/ansible
          path: ansible

      - name: Checkout MythTV/mythtv repo
        uses: actions/checkout@v3
        with:
          repository: MythTV/mythtv
          path: mythtv

      - name: Run ansible to install build requirements
        working-directory: ./ansible
        run: ansible-playbook -i hosts qt5.yml

      - name: Redhat/Fedora OS install extra packages (for greater coverage)
        run: dnf install ant python-setuptools qt5-qtbase-private-devel clang -y

      - name: Setup build environment
        run: |
          echo "MYTHTV_CONFIG=--prefix=${{ github.workspace }}/build/install --cc=${{ matrix.compiler.cc }} --cxx=${{ matrix.compiler.cxx }}" >> $GITHUB_ENV
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV

      - name: Checkout ccache
        uses: actions/cache@v3
        with:
          path: ~/.ccache
          key: fedora-rawhide-clang-tidy-ccache-${{ github.sha }}
          restore-keys: fedora-rawhide-clang-tidy-ccache

      - name: ccache statistics [pre]
        run: ccache -sV

      - name: Configure core
        working-directory: ./mythtv
        run: ./configure $MYTHTV_CONFIG --enable-libmp3lame --enable-libvpx --enable-libx264 --enable-libx265 --enable-bdjava --enable-vulkan

      - name: Make core
        working-directory: ./mythtv
        run: make all_no_test -j4

      - name: Install core
        working-directory: ./mythtv
        run: make install

      - name: Unit test core
        working-directory: ./mythtv
        run: make test

      - name: Configure plugins
        working-directory: ./mythplugins
        run: ./configure $MYTHTV_CONFIG

      - name: Make plugins
        working-directory: ./mythplugins
        run: make -j4

      - name: ccache statistics [post]
        run: |
          ccache -sV

